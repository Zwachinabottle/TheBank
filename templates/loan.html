<!DOCTYPE html>
<html lang="en" class="{{ session.get('theme', 'dark') }}-mode">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Account Dashboard â€” Loan</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    /* ---------- MODAL ---------- */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

.modal-overlay.active {
  display: flex;
}

.modal {
  background: var(--bg3);
  padding: 28px;
  border-radius: 16px;
  width: 100%;
  max-width: 420px;
  border: 1px solid var(--border);
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.modal-close {
  margin-top: 16px;
  width: 100%;
  padding: 10px;
  border-radius: 10px;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text);
  cursor: pointer;
}

    :root{
      --brand: #24bff0;
      --accent: #1bb1e9;

      --bg: #11191c;
      --bg2: #1a2c32;
      --card: #182429;
      --muted: #9db6bd;
      --text: #d7e6eb;
      --input-bg: #243238;
      --border: #2e4b52;
      --rounded: 14px;
      --glass: rgba(255,255,255,0.03);
    }

    .light-mode {
      --bg: #e7eef2;
      --bg2: #f5f8fa;
      --card: #ffffff;
      --muted: #556166;
      --text: #1b1f21;
      --input-bg: #ecf1f3;
      --border: #c7d2d6;
      --glass: rgba(0,0,0,0.02);
    }

    /* Basic reset + layout */
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:"Inter",system-ui;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;}
    body{display:flex;align-items:stretch;gap:20px; padding:24px;overflow:hidden;}

    /* Side banners (decorative) */
    .side-banner{flex:1;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--bg2), rgba(0,0,0,0.02));border-radius:12px;border:1px solid var(--border);color:var(--muted);font-size:13px;min-width:80px;padding:12px}
    .side-banner img{max-width:100%;border-radius:8px}

    /* Center column */
    .center-column{
      flex:5; max-width:1100px; margin:auto; height:calc(100vh - 48px); overflow:auto;
      border-radius:16px; padding:28px;
      background: linear-gradient(175deg,var(--card), rgba(0,0,0,0.02));
      border:1px solid var(--border);
      box-shadow: 0 8px 40px rgba(0,0,0,0.35);
    }

    /* Top bar */
    .top-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{
      display:flex;align-items:center;gap:12px;
    }
    .logo{
      width:54px;height:54px;border-radius:12px;
      background:linear-gradient(135deg,var(--brand),var(--accent));
      display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;box-shadow: 0 6px 18px rgba(36,191,240,0.12);
    }
    h1{margin:0;font-size:22px}

    .small-muted{color:var(--muted);font-size:13px}

    /* Layout blocks */
    .grid{
      display:grid;grid-template-columns: 1fr 360px;gap:20px;margin-top:20px;
    }
    @media (max-width:900px){
      body{padding:12px}
      .grid{grid-template-columns:1fr}
      .side-banner{display:none}
    }

    /* Card */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border-radius: var(--rounded);
      padding:18px;
      border:1px solid var(--border);
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
    }

    /* Loan calculator */
    .calculator .card-header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px;
    }
    .pill{
      background: rgba(255,255,255,0.03);
      padding:6px 10px;border-radius:999px;font-weight:600;color:var(--text);
      display:inline-flex;align-items:center;gap:8px;font-size:13px;border:1px solid var(--border);
    }

    .field{display:flex;flex-direction:column;margin-top:12px}
    .field label{font-size:13px;margin-bottom:6px;color:var(--muted)}
    .field input[type="number"], .field input[type="text"], .field input[type="tel"]{
      padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:var(--input-bg);color:var(--text);font-size:15px;
      transition: box-shadow .18s ease, border-color .12s ease, transform .12s ease;
      outline: none;
    }
    .field input::placeholder{color:var(--muted)}
    .field input:focus{
      border-color:var(--brand);
      box-shadow: 0 6px 18px rgba(36,191,240,0.12);
      transform: translateY(-1px);
    }

    .hint{font-size:13px;color:var(--muted);margin-top:6px}

    .results{
      margin-top:18px;display:flex;gap:12px;align-items:stretch;
    }
    .result-card{
      flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border:1px solid var(--border);
      display:flex;flex-direction:column;justify-content:center;align-items:flex-start;
    }
    .result-card .label{font-size:13px;color:var(--muted)}
    .result-number{font-size:20px;font-weight:700;margin-top:6px;letter-spacing:0.4px;min-width:140px}

    /* animated number */
    .number-flash{animation: pop 380ms cubic-bezier(.2,.9,.3,1);}
    @keyframes pop{
      0%{opacity:.25;transform:translateY(6px) scale(.98)}
      60%{opacity:1;transform:translateY(-4px) scale(1.02)}
      100%{transform:translateY(0) scale(1)}
    }

    /* Apply card */
    .apply-actions{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .btn{
      padding:14px;border-radius:12px;border:0;font-weight:700;cursor:pointer;font-size:15px;
      background:linear-gradient(135deg,var(--brand),var(--accent));color:white;box-shadow: 0 8px 22px rgba(36,191,240,0.12);
    }
    .btn.secondary{background:transparent;border:1px solid var(--border);color:var(--text);font-weight:600}

    /* history / right column */
    .history-list{display:flex;flex-direction:column;gap:10px}
    .history-item{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;background:var(--glass);border:1px solid var(--border)}
    .history-item .meta{display:flex;flex-direction:column}
    .history-item .meta .reason{font-weight:700}
    .history-item .meta .sub{color:var(--muted);font-size:13px}

    /* footer info */
    .footer{margin-top:20px;color:var(--muted);font-size:13px;text-align:center;padding-bottom:30px}

    /* theme toggle + logout */
    .controls{display:flex;gap:10px;align-items:center}
    .toggle-btn{width:48px;height:28px;border-radius:999px;border:2px solid var(--border);background:var(--input-bg);position:relative;cursor:pointer}
    .toggle-btn::after{content:"";position:absolute;width:22px;height:22px;border-radius:50%;top:2px;left:2px;background:var(--brand);transition:transform .22s ease}
    .light-mode .toggle-btn::after{transform:translateX(20px)}
    .logout-btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:var(--input-bg);color:var(--text);text-decoration:none;font-weight:600}

    /* toast */
    #toast{position:fixed;top:20px;right:20px;background:linear-gradient(90deg,var(--brand),var(--accent));color:#fff;padding:12px 16px;border-radius:10px;font-weight:700;box-shadow:0 12px 30px rgba(0,0,0,0.25);display:none;z-index:9999}

    /* small helpers */
    .muted{color:var(--muted)}
    .gap{height:12px}
  </style>
</head>
<body>
  <!-- TRANSACTION MODAL -->
<div class="modal-overlay" id="transactionModal">
  <div class="modal">
    <h2>Make a Transaction</h2>

    <form method="POST" action="{{ url_for('transfer') }}">
      <input type="text" name="receiver" placeholder="Receiver Username" required>
      <input type="number" name="amount" placeholder="Amount" required>
      <input type="text" name="comment" placeholder="Comment (optional)">
      <button type="submit">Send Money</button>
    </form>

    <button class="modal-close" onclick="closeTransaction()">Cancel</button>
  </div>
</div>
  <!-- left decorative banner -->
    <div class="side-banner">
    <a href="{{ url_for('loan') }}" class="loan-btn">
        <img src="{{ url_for('static', filename='banner.png') }}" alt="Funny Banner" style="height: 400px;">
    </a>
    </div>

  <!-- main content -->
  <main class="center-column" role="main" aria-labelledby="pageTitle">
    <div class="top-row">
      <div class="brand">
        <div class="logo">AH</div>
        <div>
          <h1 id="pageTitle">Hey, {{ username }}!</h1>
          <div class="small-muted">Welcome back â€” manage loans and requests here</div>
        </div>
      </div>

      <div class="controls">
        <div class="small-muted">Interest: <strong>{{ (irate * 100) | round(2) }}%</strong> / week</div>
        <div class="small-muted">Final payments due <strong>May 9, 2025</strong></div>

        <button class="toggle-btn" id="theme-toggle" aria-label="Toggle theme"></button>
        <a class="logout-btn" href="{{ url_for('logout') }}">Logout</a>
      </div>
    </div>

    <div>
      <!-- left column: calculator + form -->
        <div class="card calculator" aria-labelledby="calcTitle">
          <div class="card-header">
            <div class="pill">ðŸ’° Loan Calculator</div>
            <div class="muted">Instant preview â€” client-side</div>
          </div>

          <div class="field">
            <label for="amount">Amount</label>
            <input id="amount" type="number" min="50" max="1000" placeholder="Enter amount (50 - 1000)">
            <div class="hint">Try values between $50 and $1,000</div>
          </div>

          <div class="field">
            <label for="weeks">Weeks</label>
            <input id="weeks" type="number" min="1" max="9" placeholder="Repayment period in weeks (1 - 9)">
            <div class="hint">Loans must be repaid within 9 weeks</div>
          </div>

          <div class="results" aria-live="polite">
            <div class="result-card">
              <div class="label">Total Repayment</div>
              <div id="totalRepayment" class="result-number">â€”</div>
            </div>

            <div class="result-card">
              <div class="label">Weekly Payment</div>
              <div id="weeklyPayment" class="result-number">â€”</div>
            </div>
          </div>

          <div class="gap"></div>

          <div class="apply-actions">
            <!-- Apply form uses the same values, but posts to server -->
            <form method="POST" action="{{ url_for('loan') }}" id="applyForm" class="apply-form" novalidate>
              <div class="field">
                <label for="reason">Reason</label>
                <input id="reason" name="reason" type="text" placeholder="Why do you need this loan?" required>
              </div>

              <div style="display:flex;gap:10px;margin-top:8px">
                <input name="amount" id="applyAmount" type="number" min="50" max="1000" placeholder="Amount" required style="flex:1">
                <input name="weeks" id="applyWeeks" type="number" min="1" max="9" placeholder="Weeks" required style="width:140px">
              </div>

              <div style="display:flex;gap:10px;margin-top:10px">
                <button type="submit" class="btn">Apply for Loan</button>
                <button type="button" id="prefillBtn" class="btn secondary">Use Preview</button>
              </div>

              <div class="hint" style="margin-top:8px">Loans incur a <strong>{{ irate }}</strong> weekly interest fee on the amount borrowed. Final payment date: May 9, 2025.</div>
            </form>
          </div>
        </div>

        <div class="card" style="margin-top:16px">
          <div class="pill">ðŸ“Œ Tips</div>
          <ul style="margin:10px 0 0 18px;color:var(--muted)">
            <li>Keep amounts modest for quick repayment.</li>
            <li>Use the preview to confirm weekly payments before applying.</li>
          </ul>
        </div>

    </div>
  </main>

  <!-- right decorative banner -->
  <div class="side-banner">
    <div style="text-align:center">
      <div style="font-weight:700">Need help?</div>
      <div class="small-muted">Ask your facilitator</div>
    </div>
  </div>

  <!-- toast -->
  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    // Parse interest rate passed from Flask safely as a string -> float
    const rate = parseFloat('{{ irate }}');

    // Elements
    const amountInput = document.getElementById('amount');
    const weeksInput = document.getElementById('weeks');
    const totalEl = document.getElementById('totalRepayment');
    const weeklyEl = document.getElementById('weeklyPayment');

    const applyAmount = document.getElementById('applyAmount');
    const applyWeeks = document.getElementById('applyWeeks');
    const prefillBtn = document.getElementById('prefillBtn');
    const reasonInput = document.getElementById('reason');

    // animate field helper
    function animateField(el, text) {
      el.textContent = text;
      el.classList.remove('number-flash');
      void el.offsetWidth; // force reflow to restart animation
      el.classList.add('number-flash');
    }

    function calculateAndUpdate() {
      const amount = parseFloat(amountInput.value) || 0;
      const weeks = parseInt(weeksInput.value) || 1;

      // protect division by zero
      const safeWeeks = Math.max(1, weeks);

      const total_interest = amount * rate * safeWeeks;
      const total_repayment = amount + total_interest;
      const weekly_payment = total_repayment / safeWeeks;

      animateField(totalEl, total_repayment.toFixed(2));
      animateField(weeklyEl, weekly_payment.toFixed(2));
    }

    // Keep apply form inputs in sync with preview (prefill)
    prefillBtn.addEventListener('click', () => {
      applyAmount.value = amountInput.value || '';
      applyWeeks.value = weeksInput.value || '';
      reasonInput.focus();
    });

    // Live updates
    amountInput.addEventListener('input', calculateAndUpdate);
    weeksInput.addEventListener('input', calculateAndUpdate);

    // initialize preview values
    document.addEventListener('DOMContentLoaded', () => {
      // fill defaults if empty
      if(!amountInput.value) amountInput.value = '';
      if(!weeksInput.value) weeksInput.value = '';
      calculateAndUpdate();

      // if URL contains loan=success, show toast
      if (window.location.search.includes('loan=success')) {
        showToast('Loan Request Submitted!');
      }
    });

    // Theme toggle (talks to your /toggle-theme endpoint)
    const toggleBtn = document.getElementById('theme-toggle');
    async function applyTheme(theme){
      if(theme === 'light') {
        document.documentElement.classList.remove('dark-mode');
        document.documentElement.classList.add('light-mode');
      } else {
        document.documentElement.classList.remove('light-mode');
        document.documentElement.classList.add('dark-mode');
      }
    }
    // initial theme already set by server; keep ability to switch
    toggleBtn.addEventListener('click', async () => {
      try {
        const r = await fetch('/toggle-theme', { method: 'POST' });
        if (r.ok){
          const data = await r.json();
          applyTheme(data.theme);
        }
      } catch(e){
        console.warn('Toggle theme error', e);
      }
    });

    // Toast helper
    function showToast(message, ms = 3200) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.display = 'block';
      toast.style.opacity = '1';
      setTimeout(()=> {
        toast.style.transition = 'opacity .35s ease';
        toast.style.opacity = '0';
        setTimeout(()=> toast.style.display = 'none', 400);
      }, ms);
    }

    // Small accessibility: allow Enter key in calculator to copy to apply inputs
    [amountInput, weeksInput].forEach(inp=>{
      inp.addEventListener('keydown', (e) => {
        if(e.key === 'Enter') {
          e.preventDefault();
          prefillBtn.click();
          showToast('Preview copied to apply form');
        }
      });
    });

    // Optional: if you want to validate the apply form on client before sending
    document.getElementById('applyForm').addEventListener('submit', (e) => {
      const amt = parseFloat(applyAmount.value);
      const wks = parseInt(applyWeeks.value);
      if (isNaN(amt) || amt < 50 || amt > 1000) {
        e.preventDefault();
        showToast('Please enter an amount between $50 and $1000');
        applyAmount.focus();
        return false;
      }
      if (isNaN(wks) || wks < 1 || wks > 9) {
        e.preventDefault();
        showToast('Please select weeks between 1 and 9');
        applyWeeks.focus();
        return false;
      }
      // let submission proceed â€” server will handle final creation and redirect
    });
  </script>
</body>
</html>
